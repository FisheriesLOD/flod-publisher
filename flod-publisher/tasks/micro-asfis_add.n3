@prefix sr:   <http://semanticrepository/publisher/task#> .
@prefix dct:  <http://purl.org/dc/terms/> . 
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>


<sr:micro-asfis-add>         a sr:Task ;

rdfs:label                   "Update of mini asfis";

dct:creator                  <http://semanticrepository/people/claudio.baldassarre> ;
skos:editorialNote           "Generated by the Semantic Repository LOD maintenance framework" ;

sr:source_endpoint           <http://168.202.3.223:3030/sr_staging/query> ;

sr:source_graph              <http://semanticrepository/staging/graph/1.1/micro_asfis_add> ;

sr:publication_endpoint      <http://168.202.3.223:3030/sr_public/update> ;

sr:target_graph              <http://semanticrepository/public/graph/1.2/micro_asfis> ;

#sr:depending_graph          <http://semanticrepository/graph/depending_graph1> ;
#sr:depending_graph          <http://semanticrepository/graph/depending_graph2> ;

#change in: operation
sr:operation                 sr:add;

sr:diff_query """ 
    CONSTRUCT 
     { ?codeTr ?p ?x .
       ?coded_entity ?r ?y .
     }   WHERE
     { GRAPH <http://semanticrepository/staging/graph/transformed>
            {?codeTr <http://www.ontologydesignpatterns.org/cp/owl/classification.owl#classifies> ?coded_entity .
              ?coded_entity ?r ?y.
              ?codeTr ?p ?x
            filter(
            not exists {
                GRAPH <http://semanticrepository/public/graph/1.2/micro_asfis>
         { ?codeTr <http://www.ontologydesignpatterns.org/cp/owl/classification.owl#classifies> ?o}
            })
            }
} """;

sr:query     """
  PREFIX  rdfs:    <http://www.w3.org/2000/01/rdf-schema#>
  PREFIX  cls:     <http://www.fao.org/figis/flod/onto/codedentityclassification.owl#>
  PREFIX  cls_odp: <http://www.ontologydesignpatterns.org/cp/owl/classification.owl#>
  PREFIX  ce:      <http://www.fao.org/figis/flod/onto/codedentity.owl#>
  PREFIX  fn:      <http://www.w3.org/2005/xpath-functions#>
  PREFIX  skos:    <http://www.w3.org/2004/02/skos/core#>
  PREFIX  dct:     <http://purl.org/dc/terms/> 
  
  CONSTRUCT 
    { ?coded_entity a ce:CodedEntity .
      ?coded_entity rdfs:label ?code_label_str . 
      ?coded_entity skos:prefLabel ?code_label_str . 
      ?coded_entity cls:isClassfiedByCode ?code .
      ?coded_entity dct:subject ?code .
      ?code a <http://www.fao.org/figis/flod/onto/linneanspecies.owl#SpeciesCode> .
      ?code rdfs:label ?alpha_code .
      ?code skos:notation ?alpha_code .
      ?code cls_odp:classifies ?coded_entity .}
 WHERE
   { ?x <s:r/Codelist> ?system_raw .
     ?system_raw <s:r/id> ?id
     BIND(iri(fn:concat("http://www.fao.org/figis/flod/entities/codificationsystem/", fn:lower-case(str(?id)))) AS ?system)
     ?t <s:r/Code> ?code_raw .
     ?code_raw <s:r/id> ?alpha_code
     BIND(iri(fn:concat("http://www.fao.org/figis/flod/entities/speciescode/", fn:lower-case(str(?alpha_code)))) AS ?code)
     BIND(iri(fn:concat("http://www.fao.org/figis/flod/entities/codedentity/", STRUUID())) AS ?coded_entity)
     OPTIONAL{
           ?code_raw  <s:r/Name> ?code_name . 
           ?code_name <s:r/Name> ?code_label . 
           ?code_name <s:r/lang> ?lang 
           BIND(strlang(?code_label, str(?lang)) as ?code_label_str)
        } 
   }""";
.

